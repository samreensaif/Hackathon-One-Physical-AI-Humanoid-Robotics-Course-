name: Deploy Docusaurus to GitHub Pages

on:
  push:
    branches:
      - main

  # Allow manual trigger from the Actions tab
  workflow_dispatch:

permissions:
  contents: write   # needed by peaceiris/actions-gh-pages to push to gh-pages

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ── Checkout ─────────────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── Node.js ──────────────────────────────────────────────────────────
      - name: Set up Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: physical-ai-textbook/package-lock.json

      # ── Install ───────────────────────────────────────────────────────────
      - name: Install dependencies
        run: npm ci
        working-directory: physical-ai-textbook

      # ── Build ─────────────────────────────────────────────────────────────
      - name: Build Docusaurus site
        run: npm run build
        working-directory: physical-ai-textbook

      # ── Lighthouse CI ─────────────────────────────────────────────────────
      # Asserts: performance >= 85 (warn), accessibility >= 90 (error)
      # Config: lighthouserc.json at repo root
      - name: Run Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.14.x
          lhci autorun

      # ── Deploy ────────────────────────────────────────────────────────────
      - name: Deploy to gh-pages branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./physical-ai-textbook/build
          # Keep the CNAME file if you use a custom domain
          # cname: yourdomain.com
